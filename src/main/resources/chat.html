<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryoChat - å®‰å…¨é€šä¿¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #ffffff 0%, #f0f2f5 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #333;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e1e5e9;
        }
        .hidden {
            display: none !important;
        }

        /* è¿‡æ¸¡åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* è®¤è¯æ ·å¼ */
        .auth-container {
            padding: 40px;
            text-align: center;
        }
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
        }
        .logo {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #444;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #fff;
            color: #333;
        }
        input:focus {
            outline: none;
            border-color: #2c5aa0;
        }
        .btn {
            width: 100%;
            padding: 12px;
            background: #2c5aa0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #1e3d6f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background: #666;
        }
        .auth-switch {
            margin-top: 20px;
            color: #666;
        }
        .auth-switch a {
            color: #2c5aa0;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        /* èŠå¤©ç•Œé¢æ ·å¼ */
        .chat-container {
            display: flex;
            height: 80vh;
        }
        .sidebar {
            width: 300px;
            background: #1a1a1a;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .user-info {
            padding: 15px;
            background: #2c2c2c;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .chat-rooms {
            margin-bottom: 20px;
        }
        .chat-room-item {
            padding: 12px;
            margin: 5px 0;
            background: #2c2c2c;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            text-align: center;
            font-weight: 500;
        }
        .chat-room-item:hover {
            background: #3a3a3a;
        }
        .chat-room-item.active {
            background: #2c5aa0;
        }
        .chat-room-item.group::before {
            content: "ğŸ’¬ ";
        }
        .user-list {
            max-height: 300px;
            overflow-y: auto;
            flex: 1;
        }
        .user-item {
            padding: 10px;
            margin: 5px 0;
            background: #2c2c2c;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .user-item:hover {
            background: #3a3a3a;
        }
        .user-item.active {
            background: #2c5aa0;
        }
        .user-item.admin::after {
            content: " ğŸ‘‘";
        }
        .user-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .user-status.online {
            background: #2ecc71;
        }
        .user-status.offline {
            background: #e74c3c;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        .chat-header {
            padding: 20px;
            background: #ffffff;
            border-bottom: 1px solid #e1e5e9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .current-chat-info {
            font-size: 1.1em;
            font-weight: 500;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
            animation: slideUp 0.3s ease-out;
        }
        .message.self {
            background: #2c5aa0;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message.other {
            background: white;
            border: 1px solid #e1e5e9;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .message .sender {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .message .time {
            font-size: 0.8em;
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }
        .message.file {
            background: #e8f0fe;
            border: 1px solid #c5d9f1;
        }
        .file-message {
            padding: 8px;
        }
        .file-message a {
            color: #2c5aa0;
            text-decoration: none;
            font-weight: 500;
        }
        .file-message a:hover {
            text-decoration: underline;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e1e5e9;
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            background: #f8f9fa;
        }
        .chat-input button {
            padding: 12px 20px;
            background: #2c5aa0;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chat-input button:hover {
            background: #1e3d6f;
        }

        /* æ–‡ä»¶ä¸Šä¼  */
        .file-upload {
            margin: 10px 0;
            padding: 15px;
            background: #2c2c2c;
            border-radius: 8px;
        }
        .file-input {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 8px 15px;
            background: #2c5aa0;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .file-label:hover {
            background: #1e3d6f;
        }
        .file-list {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            font-size: 0.9em;
        }
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .file-list-item:last-child {
            border-bottom: none;
        }
        .file-remove {
            color: #ff6b6b;
            cursor: pointer;
            font-weight: bold;
        }
        .file-type-warning {
            color: #ffa726;
            font-size: 0.8em;
            margin-top: 5px;
        }

        /* äººæœºéªŒè¯ */
        .captcha-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e1e5e9;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e1e5e9;
            border-top: 5px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            .sidebar {
                width: 100%;
                max-height: 200px;
            }
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="auth-container fade-in">
        <div class="auth-form">
            <div class="logo">CryoChat</div>
            <div class="subtitle">å®‰å…¨ç§å¯†çš„å³æ—¶é€šè®¯</div>

            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>

            <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="rememberMe" checked>
                    10å¤©å†…è‡ªåŠ¨ç™»å½•
                </label>
            </div>

            <div class="captcha-container">
                <p><strong>äººæœºéªŒè¯</strong></p>
                <p>è¯·åœ¨ä¸‹æ–¹è¾“å…¥: <code>I am human</code></p>
                <input type="text" id="captcha" placeholder="è¾“å…¥éªŒè¯æ–‡æœ¬">
            </div>

            <button class="btn" onclick="login()">ç™»å½•</button>

            <div class="auth-switch">
                è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a onclick="showRegister()">ç«‹å³æ³¨å†Œ</a>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œé¡µé¢ -->
    <div id="registerPage" class="auth-container hidden">
        <div class="auth-form">
            <div class="logo">æ³¨å†Œè´¦å·</div>

            <div class="form-group">
                <label for="regUsername">ç”¨æˆ·å</label>
                <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>

            <div class="form-group">
                <label for="regPassword">å¯†ç </label>
                <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>

            <div class="form-group">
                <label for="regPassword2">ç¡®è®¤å¯†ç </label>
                <input type="password" id="regPassword2" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
            </div>

            <button class="btn" onclick="register()">æ³¨å†Œ</button>

            <div class="auth-switch">
                å·²æœ‰è´¦å·ï¼Ÿ <a onclick="showLogin()">ç«‹å³ç™»å½•</a>
            </div>
        </div>
    </div>

    <!-- èŠå¤©é¡µé¢ -->
    <div id="chatPage" class="hidden">
        <div class="chat-container">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <div class="user-info">
                    <div id="currentUser">ç”¨æˆ·å</div>
                    <div id="userStatus" style="font-size: 0.9em; opacity: 0.8;"></div>
                    <button onclick="refreshOnlineUsers()" style="margin-top: 10px; width: 100%; padding: 8px; background: #2c5aa0; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        åˆ·æ–°åœ¨çº¿ç”¨æˆ·
                    </button>
                    <button onclick="logout()" style="margin-top: 5px; width: 100%; padding: 8px; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        é€€å‡ºç™»å½•
                    </button>
                </div>

                <div class="file-upload">
                    <input type="file" id="fileInput" class="file-input" multiple>
                    <label for="fileInput" class="file-label">ğŸ“ é€‰æ‹©æ–‡ä»¶</label>
                    <div id="fileList" class="file-list">
                        <!-- é€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div id="fileTypeWarning" class="file-type-warning" style="display: none;">
                        <!-- æ–‡ä»¶ç±»å‹è­¦å‘Šå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <button onclick="sendFiles()" style="margin-top: 5px; width: 100%; padding: 8px; background: #2c5aa0; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        å‘é€æ–‡ä»¶
                    </button>
                </div>

                <div class="chat-rooms">
                    <div id="groupChatItem" class="chat-room-item group active">å…¨å±€ç¾¤èŠ</div>
                </div>

                <h3 style="margin: 20px 0 10px 0;">åœ¨çº¿ç”¨æˆ· (<span id="onlineCount">0</span>)</h3>
                <div id="userList" class="user-list">
                    <!-- ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="chat-area">
                <div class="chat-header">
                    <h2 id="chatWith">CryoChat èŠå¤©å®¤</h2>
                    <div class="current-chat-info">
                        å½“å‰å¯¹è¯: <span id="currentChatUser">å…¨å±€ç¾¤èŠ</span>
                        <button onclick="refreshMessages()" style="margin-left: 10px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ”„ åˆ·æ–°æ¶ˆæ¯
                        </button>
                    </div>
                </div>

                <div id="chatMessages" class="chat-messages">
                    <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    let currentUser = null;
    let isAdmin = false;
    let currentSession = null;
    let eventSource = null;
    let onlineUsersInterval = null;
    let heartbeatInterval = null;
    let selectedFiles = [];
    let currentChatTarget = 'group'; // é»˜è®¤è¿›å…¥å…¨å±€ç¾¤èŠ
    let lastMessageTime = 0;
    let messageDelay = 50; // 50æ¯«ç§’å»¶è¿Ÿ
    let allUsers = []; // å­˜å‚¨æ‰€æœ‰æ³¨å†Œç”¨æˆ·

    // æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
    const ALLOWED_FILE_TYPES = [
        'zip', 'bat', 'cmd', 'java', 'jar', 'txt', 'png', 'webp', 'jpg', 'jpeg',
        'ttf', 'xml', 'rar', 'html', 'exe', 'apk', 'mcpack', 'mcworld', 'mrpack',
        'docx', 'doc', 'gif', 'apng', 'mp4', 'mkv', 'md', 'ico', 'js', 'json',
        'appx', 'log', 'iso'
    ];

    // é¡µé¢åˆ‡æ¢
    function showRegister() {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('registerPage').classList.remove('hidden');
        document.getElementById('registerPage').classList.add('fade-in');
    }

    function showLogin() {
        document.getElementById('registerPage').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('loginPage').classList.add('fade-in');
    }

    function showChat() {
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        document.getElementById('loadingOverlay').classList.add('active');

        // å»¶è¿Ÿæ˜¾ç¤ºèŠå¤©ç•Œé¢ï¼Œè®©åŠ è½½åŠ¨ç”»æœ‰è¶³å¤Ÿæ—¶é—´æ˜¾ç¤º
        setTimeout(() => {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('registerPage').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');
            document.getElementById('chatPage').classList.add('slide-up');

            // éšè—åŠ è½½åŠ¨ç”»
            document.getElementById('loadingOverlay').classList.remove('active');
        }, 1000);
    }

    // ç™»å½•åŠŸèƒ½
    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const captcha = document.getElementById('captcha').value;
        const rememberMe = document.getElementById('rememberMe').checked;

        if (!username || !password) {
            alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
            return;
        }

        if (captcha !== 'I am human') {
            alert('äººæœºéªŒè¯å¤±è´¥ï¼Œè¯·æŒ‰è¦æ±‚è¾“å…¥éªŒè¯æ–‡æœ¬');
            return;
        }

        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username,
                    password,
                    rememberMe
                })
            });

            const result = await response.json();

            if (result.success) {
                currentUser = username;
                isAdmin = result.isAdmin;
                currentSession = result.sessionId;

                document.getElementById('currentUser').textContent = username + (isAdmin ? ' (ç®¡ç†å‘˜)' : '');
                document.getElementById('userStatus').textContent = isAdmin ? 'ç®¡ç†å‘˜æ¨¡å¼' : 'ç”¨æˆ·æ¨¡å¼';

                showChat();
                connectSSE();
                loadChatHistory();
                loadAllUsers(); // åŠ è½½æ‰€æœ‰ç”¨æˆ·
                loadOnlineUsers();
                startOnlineUsersPolling();
                startHeartbeat(); // å¼€å§‹å¿ƒè·³
            } else {
                alert('ç™»å½•å¤±è´¥: ' + result.message);
            }
        } catch (error) {
            alert('ç™»å½•è¯·æ±‚å¤±è´¥: ' + error.message);
        }
    }

    // æ³¨å†ŒåŠŸèƒ½
    async function register() {
        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        const password2 = document.getElementById('regPassword2').value;

        if (!username || !password) {
            alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
            return;
        }

        if (password !== password2) {
            alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
            return;
        }

        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const result = await response.json();

            if (result.success) {
                alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                showLogin();
            } else {
                alert('æ³¨å†Œå¤±è´¥: ' + result.message);
            }
        } catch (error) {
            alert('æ³¨å†Œè¯·æ±‚å¤±è´¥: ' + error.message);
        }
    }

    // é€€å‡ºç™»å½•åŠŸèƒ½
    async function logout() {
        if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            return;
        }

        try {
            const response = await fetch('/api/logout', {
                method: 'POST',
                headers: {
                    'Cookie': 'session=' + currentSession
                }
            });

            const result = await response.json();

            if (result.success) {
                // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨å’Œè¿æ¥
                if (onlineUsersInterval) {
                    clearInterval(onlineUsersInterval);
                }
                if (heartbeatInterval) {
                    clearInterval(heartbeatInterval);
                }
                if (eventSource) {
                    eventSource.close();
                }

                // é‡ç½®å…¨å±€å˜é‡
                currentUser = null;
                currentSession = null;

                // æ¸…é™¤cookie
                document.cookie = "session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

                // æ˜¾ç¤ºç™»å½•é¡µé¢
                document.getElementById('chatPage').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');

                alert('å·²æˆåŠŸé€€å‡ºç™»å½•');
            } else {
                alert('é€€å‡ºç™»å½•å¤±è´¥: ' + result.message);
            }
        } catch (error) {
            alert('é€€å‡ºç™»å½•è¯·æ±‚å¤±è´¥: ' + error.message);
        }
    }

    // å¿ƒè·³åŠŸèƒ½ - å®šæœŸå‘é€æ´»åŠ¨çŠ¶æ€
    function startHeartbeat() {
        // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å¿ƒè·³
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
        }

        // ç«‹å³å‘é€ä¸€æ¬¡å¿ƒè·³
        sendHeartbeat();

        // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
        heartbeatInterval = setInterval(sendHeartbeat, 30000);
    }

    // å‘é€å¿ƒè·³
    async function sendHeartbeat() {
        if (!currentSession) return;

        try {
            await fetch('/api/heartbeat', {
                method: 'POST',
                headers: {
                    'Cookie': 'session=' + currentSession
                }
            });
        } catch (error) {
            console.error('å¿ƒè·³å‘é€å¤±è´¥:', error);
        }
    }

    // SSEè¿æ¥
    function connectSSE() {
        if (eventSource) {
            eventSource.close();
        }

        eventSource = new EventSource('/api/sse', { withCredentials: true });

        eventSource.onmessage = function(event) {
            const message = JSON.parse(event.data);

            // å¿½ç•¥å¿ƒè·³æ¶ˆæ¯
            if (message.type === 'heartbeat') {
                return;
            }

            // æ·»åŠ æ¶ˆæ¯å»¶è¿Ÿï¼Œé¿å…é‡å¤æ¶ˆæ¯
            const currentTime = Date.now();
            if (currentTime - lastMessageTime < messageDelay) {
                console.log('æ¶ˆæ¯å»¶è¿Ÿï¼Œå¿½ç•¥é‡å¤æ¶ˆæ¯');
                return;
            }
            lastMessageTime = currentTime;

            // ç¾¤èŠæ¶ˆæ¯æ˜¾ç¤ºç»™æ‰€æœ‰äºº
            if (message.to === 'group' ||
                (currentChatTarget === 'group' && message.to === currentUser) ||
                (currentChatTarget !== 'group' && (message.to === currentUser || message.from === currentChatTarget))) {
                displayMessage(message);
            }
        };

        eventSource.onopen = function() {
            console.log('SSEè¿æ¥å·²å»ºç«‹');
        };

        eventSource.onerror = function(error) {
            console.error('SSEè¿æ¥é”™è¯¯:', error);
            if (eventSource.readyState === EventSource.CLOSED) {
                eventSource.close();
                // å°è¯•é‡è¿
                setTimeout(connectSSE, 5000);
            }
        };
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (message) {
            const chatMessage = {
                type: 'text',
                to: currentChatTarget,
                content: message
            };

            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Cookie': 'session=' + currentSession
                },
                body: JSON.stringify(chatMessage)
            }).then(response => response.json())
              .then(result => {
                  if (result.success) {
                      input.value = '';
                      // ç«‹å³æ˜¾ç¤ºè‡ªå·±å‘é€çš„æ¶ˆæ¯
                      const tempMessage = {
                          from: currentUser,
                          to: currentChatTarget,
                          content: message,
                          type: 'text'
                      };
                      displayMessage(tempMessage);
                  } else {
                      alert('å‘é€å¤±è´¥: ' + result.message);
                  }
              })
              .catch(error => {
                  alert('å‘é€é”™è¯¯: ' + error.message);
              });
        }
    }

    // å¤„ç†æŒ‰é”®äº‹ä»¶
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function displayMessage(message) {
        const messagesDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');

        // ç¡®å®šæ¶ˆæ¯æ ·å¼
        let messageClass = 'message ';
        if (message.from === currentUser) {
            messageClass += 'self';
        } else {
            messageClass += 'other';
        }

        messageDiv.className = messageClass;

        const time = new Date().toLocaleTimeString();

        let contentHtml = '';
        if (message.type === 'file') {
            // æ–‡ä»¶æ¶ˆæ¯æ˜¾ç¤º
            const fileInfo = message.fileInfo || {};
            contentHtml = `
                <div class="file-message">
                    <strong>ğŸ“ æ–‡ä»¶:</strong> ${fileInfo.originalName || 'æœªçŸ¥æ–‡ä»¶'}<br>
                    <small>å¤§å°: ${formatFileSize(fileInfo.size || 0)}</small><br>
                    ${fileInfo.downloadUrl ? `<a href="${fileInfo.downloadUrl}" target="_blank" style="color: #2c5aa0;">ä¸‹è½½æ–‡ä»¶</a>` : ''}
                </div>
            `;
        } else {
            // æ–‡æœ¬æ¶ˆæ¯
            contentHtml = `<div class="content">${escapeHtml(message.content)}</div>`;
        }

        messageDiv.innerHTML = `
            ${message.from !== currentUser ? `<div class="sender">${escapeHtml(message.from)}</div>` : ''}
            ${contentHtml}
            <div class="time">${time}</div>
        `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    function isFileTypeAllowed(filename) {
        const extension = filename.split('.').pop().toLowerCase();
        return ALLOWED_FILE_TYPES.includes(extension);
    }

    // æ–‡ä»¶å¤„ç†
    async function sendFiles() {
        if (selectedFiles.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
            return;
        }

        // æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶ç±»å‹
        const invalidFiles = selectedFiles.filter(file => !isFileTypeAllowed(file.name));
        if (invalidFiles.length > 0) {
            alert(`ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼Œè¯·å‹ç¼©åå†ä¸Šä¼ :\n${invalidFiles.map(f => f.name).join('\n')}\n\næ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${ALLOWED_FILE_TYPES.join(', ')}`);
            return;
        }

        try {
            // å¯¹äºå¤šä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬é€ä¸ªä¸Šä¼ 
            for (let file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('username', currentUser);
                formData.append('session', currentSession);
                formData.append('targetUser', currentChatTarget);

                console.log('ä¸Šä¼ æ–‡ä»¶:', file.name, 'å¤§å°:', file.size, 'ç±»å‹:', file.type);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}, è¯¦æƒ…: ${errorText}`);
                }

                const result = await response.json();

                if (result.success) {
                    console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', file.name);
                    console.log('æœåŠ¡å™¨è¿”å›çš„æ–‡ä»¶ä¿¡æ¯:', result.fileInfo);

                    // ç«‹å³æ˜¾ç¤ºæ–‡ä»¶æ¶ˆæ¯
                    const fileMessage = {
                        type: 'file',
                        from: currentUser,
                        to: currentChatTarget,
                        content: `å‘é€æ–‡ä»¶: ${file.name} (${formatFileSize(file.size)})`,
                        fileInfo: result.fileInfo
                    };
                    displayMessage(fileMessage);

                    // åŒæ—¶å‘é€åˆ°æœåŠ¡å™¨
                    const chatResponse = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cookie': 'session=' + currentSession
                        },
                        body: JSON.stringify(fileMessage)
                    });

                    const chatResult = await chatResponse.json();
                    if (!chatResult.success) {
                        console.error('å‘é€æ–‡ä»¶æ¶ˆæ¯å¤±è´¥:', chatResult.message);
                    }

                } else {
                    console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', result.message);
                    alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + file.name + ': ' + result.message);
                }
            }

            alert('æ‰€æœ‰æ–‡ä»¶å‘é€æˆåŠŸ');
            clearFileList();

        } catch (error) {
            console.error('æ–‡ä»¶ä¸Šä¼ é”™è¯¯:', error);
            alert('æ–‡ä»¶ä¸Šä¼ é”™è¯¯: ' + error.message);
        }
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 å­—èŠ‚';
        const k = 1024;
        const sizes = ['å­—èŠ‚', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // åŠ è½½èŠå¤©è®°å½•
    async function loadChatHistory() {
        try {
            const response = await fetch('/api/chat/history', {
                method: 'GET',
                headers: {
                    'Cookie': 'session=' + currentSession
                }
            });

            if (response.ok) {
                const history = await response.json();
                if (history.success && history.messages) {
                    // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
                    document.getElementById('chatMessages').innerHTML = '';

                    let filteredMessages = [];
                    if (currentChatTarget === 'group') {
                        // ç¾¤èŠæ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
                        filteredMessages = history.messages;
                    } else {
                        // ç§èŠåªæ˜¾ç¤ºä¸å½“å‰èŠå¤©ç›®æ ‡ç›¸å…³çš„æ¶ˆæ¯
                        filteredMessages = history.messages.filter(msg =>
                            (msg.to === currentUser && msg.from === currentChatTarget) ||
                            (msg.from === currentUser && msg.to === currentChatTarget)
                        );
                    }

                    // æŒ‰æ—¶é—´æ’åº
                    filteredMessages.sort((a, b) => {
                        const timeA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                        const timeB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                        return timeA - timeB;
                    });

                    filteredMessages.forEach(message => {
                        displayMessage(message);
                    });
                    console.log('åŠ è½½äº†', filteredMessages.length, 'æ¡å†å²æ¶ˆæ¯');
                }
            } else {
                console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥: HTTP', response.status);
            }
        } catch (error) {
            console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
        }
    }

    // åˆ·æ–°æ¶ˆæ¯
    async function refreshMessages() {
        console.log('å¼€å§‹åˆ·æ–°æ¶ˆæ¯...');

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        document.getElementById('loadingOverlay').classList.add('active');

        try {
            // æ¸…ç©ºå½“å‰æ¶ˆæ¯æ˜¾ç¤º
            document.getElementById('chatMessages').innerHTML = '';

            // é‡ç½®æ¶ˆæ¯å»¶è¿Ÿæ—¶é—´ï¼Œé¿å…é‡å¤æ¶ˆæ¯æ£€æŸ¥
            lastMessageTime = 0;

            // é‡æ–°åŠ è½½èŠå¤©è®°å½•
            await loadChatHistory();

            console.log('æ¶ˆæ¯åˆ·æ–°å®Œæˆ');

        } catch (error) {
            console.error('åˆ·æ–°æ¶ˆæ¯å¤±è´¥:', error);
            alert('åˆ·æ–°æ¶ˆæ¯å¤±è´¥: ' + error.message);
        } finally {
            // éšè—åŠ è½½åŠ¨ç”»
            document.getElementById('loadingOverlay').classList.remove('active');
        }
    }

    // åŠ è½½æ‰€æœ‰ç”¨æˆ·
    async function loadAllUsers() {
        try {
            const response = await fetch('/api/users/all', {
                method: 'GET',
                headers: {
                    'Cookie': 'session=' + currentSession
                }
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    allUsers = result.allUsers || [];
                    console.log('åŠ è½½æ‰€æœ‰ç”¨æˆ·:', allUsers);
                }
            }
        } catch (error) {
            console.error('åŠ è½½æ‰€æœ‰ç”¨æˆ·å¤±è´¥:', error);
            // å¦‚æœAPIä¸å­˜åœ¨ï¼Œä½¿ç”¨åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ä½œä¸ºå¤‡é€‰
            allUsers = [];
        }
    }

    // åŠ è½½åœ¨çº¿ç”¨æˆ·
    async function loadOnlineUsers() {
        try {
            const response = await fetch('/api/users/online', {
                method: 'GET',
                headers: {
                    'Cookie': 'session=' + currentSession
                }
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    updateOnlineUsersList(result.onlineUsers);
                }
            }
        } catch (error) {
            console.error('åŠ è½½åœ¨çº¿ç”¨æˆ·å¤±è´¥:', error);
        }
    }

    // åˆ·æ–°åœ¨çº¿ç”¨æˆ·
    async function refreshOnlineUsers() {
        await loadOnlineUsers();
    }

    // å¼€å§‹è½®è¯¢åœ¨çº¿ç”¨æˆ·
    function startOnlineUsersPolling() {
        onlineUsersInterval = setInterval(loadOnlineUsers, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
    }

    // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    function updateOnlineUsersList(onlineUsers) {
        const userListDiv = document.getElementById('userList');
        const onlineCountSpan = document.getElementById('onlineCount');

        userListDiv.innerHTML = '';

        // è¿‡æ»¤æ‰å½“å‰ç”¨æˆ·
        const filteredUsers = onlineUsers.filter(user => user !== currentUser);
        onlineCountSpan.textContent = filteredUsers.length;

        if (filteredUsers.length === 0) {
            userListDiv.innerHTML = '<div class="user-item">æš‚æ— å…¶ä»–åœ¨çº¿ç”¨æˆ·</div>';
            return;
        }

        filteredUsers.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            if (user === currentChatTarget) {
                userItem.classList.add('active');
            }
            if (user === 'admin') {
                userItem.classList.add('admin');
            }

            // æ·»åŠ åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusSpan = document.createElement('span');
            statusSpan.className = 'user-status online';
            statusSpan.title = 'åœ¨çº¿';

            userItem.appendChild(statusSpan);
            userItem.appendChild(document.createTextNode(user));

            userItem.onclick = () => selectUser(user);
            userListDiv.appendChild(userItem);
        });
    }

    // é€‰æ‹©ç”¨æˆ·è¿›è¡ŒèŠå¤©
    function selectUser(username) {
        if (username === currentUser) return;

        currentChatTarget = username;
        document.getElementById('currentChatUser').textContent = username;

        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨é«˜äº®
        document.querySelectorAll('.user-item').forEach(item => {
            item.classList.remove('active');
            if (item.textContent === username) {
                item.classList.add('active');
            }
        });

        // æ›´æ–°ç¾¤èŠé«˜äº®
        document.getElementById('groupChatItem').classList.remove('active');

        // é‡æ–°åŠ è½½ä¸è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
        loadChatHistory();

        // æ¸…ç©ºå½“å‰æ¶ˆæ¯æ˜¾ç¤º
        document.getElementById('chatMessages').innerHTML = '';
    }

    // é€‰æ‹©ç¾¤èŠ
    function selectGroupChat() {
        currentChatTarget = 'group';
        document.getElementById('currentChatUser').textContent = 'å…¨å±€ç¾¤èŠ';

        // æ›´æ–°ç¾¤èŠé«˜äº®
        document.getElementById('groupChatItem').classList.add('active');

        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨é«˜äº®
        document.querySelectorAll('.user-item').forEach(item => {
            item.classList.remove('active');
        });

        // é‡æ–°åŠ è½½ç¾¤èŠè®°å½•
        loadChatHistory();

        // æ¸…ç©ºå½“å‰æ¶ˆæ¯æ˜¾ç¤º
        document.getElementById('chatMessages').innerHTML = '';
    }

    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    function handleFileSelection(files) {
        selectedFiles = Array.from(files);
        updateFileList();

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        const invalidFiles = selectedFiles.filter(file => !isFileTypeAllowed(file.name));
        const warningDiv = document.getElementById('fileTypeWarning');

        if (invalidFiles.length > 0) {
            warningDiv.style.display = 'block';
            warningDiv.innerHTML = `ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ: ${invalidFiles.map(f => f.name).join(', ')}<br>æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${ALLOWED_FILE_TYPES.join(', ')}`;
        } else {
            warningDiv.style.display = 'none';
        }
    }

    // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
    function updateFileList() {
        const fileListDiv = document.getElementById('fileList');
        fileListDiv.innerHTML = '';

        if (selectedFiles.length === 0) {
            fileListDiv.innerHTML = '<div style="text-align: center; opacity: 0.7;">æœªé€‰æ‹©æ–‡ä»¶</div>';
            return;
        }

        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-list-item';
            const isAllowed = isFileTypeAllowed(file.name);
            fileItem.innerHTML = `
                <span style="${!isAllowed ? 'color: #ff6b6b;' : ''}">${file.name}</span>
                <span class="file-remove" onclick="removeFile(${index})">Ã—</span>
            `;
            fileListDiv.appendChild(fileItem);
        });
    }

    // ç§»é™¤æ–‡ä»¶
    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFileList();

        // æ›´æ–°è­¦å‘Šä¿¡æ¯
        const invalidFiles = selectedFiles.filter(file => !isFileTypeAllowed(file.name));
        const warningDiv = document.getElementById('fileTypeWarning');
        if (invalidFiles.length === 0) {
            warningDiv.style.display = 'none';
        }
    }

    // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
    function clearFileList() {
        selectedFiles = [];
        updateFileList();
        document.getElementById('fileInput').value = '';
        document.getElementById('fileTypeWarning').style.display = 'none';
    }

    // æ·»åŠ æ–‡ä»¶é€‰æ‹©ç›‘å¬å™¨
    document.getElementById('fileInput').addEventListener('change', function(e) {
        handleFileSelection(e.target.files);
    });

    // æ·»åŠ ç¾¤èŠç‚¹å‡»äº‹ä»¶
    document.getElementById('groupChatItem').addEventListener('click', selectGroupChat);

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', function() {
        if (onlineUsersInterval) {
            clearInterval(onlineUsersInterval);
        }
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
        }
        if (eventSource) {
            eventSource.close();
        }

        // å‘é€ç™»å‡ºè¯·æ±‚
        if (currentSession) {
            fetch('/api/logout', {
                method: 'POST',
                headers: {
                    'Cookie': 'session=' + currentSession
                }
            }).catch(() => {}); // å¿½ç•¥é”™è¯¯
        }
    });

    // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            // é¡µé¢é‡æ–°å¯è§æ—¶é‡æ–°è¿æ¥SSE
            if (currentSession && (!eventSource || eventSource.readyState === EventSource.CLOSED)) {
                console.log('é¡µé¢é‡æ–°å¯è§ï¼Œé‡æ–°è¿æ¥SSE');
                connectSSE();
                loadOnlineUsers();
            }
        }
    });

    // åˆå§‹åŒ–
    document.getElementById('messageInput').focus();
    updateFileList(); // åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
</script>
</body>
</html>